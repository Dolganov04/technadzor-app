<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–¢–ù: –ü—Ä–µ–¥–ø–∏—Å–∞–Ω–∏–µ</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            --bg-color: #ffffff;
            --text-color: #000000;
            --secondary-bg: #f5f5f5;
            --hint-color: #888888;
            --btn-color: #2481cc;
            --btn-text: #ffffff;
            --danger-color: #ff3b30;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--tg-theme-bg-color, var(--bg-color));
            color: var(--tg-theme-text-color, var(--text-color));
            padding: 16px;
            margin: 0;
            padding-bottom: 100px;
        }

        h2 { font-size: 18px; margin: 0 0 15px 0; }
        
        label {
            display: block;
            margin-top: 12px;
            margin-bottom: 4px;
            font-size: 13px;
            font-weight: 500;
            color: var(--tg-theme-hint-color, var(--hint-color));
        }

        select, input, textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 8px;
            box-sizing: border-box;
            background-color: var(--tg-theme-secondary-bg-color, var(--secondary-bg));
            color: var(--tg-theme-text-color, var(--text-color));
            font-size: 16px;
            -webkit-appearance: none;
        }

        .axis-group { display: flex; gap: 8px; }
        .axis-group select { width: 50%; }
        .hidden { display: none; }

        .btn-row { display: flex; gap: 10px; margin-top: 20px; }
        
        .btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            text-align: center;
        }

        .btn-primary {
            background-color: var(--tg-theme-button-color, var(--btn-color));
            color: var(--tg-theme-button-text-color, var(--btn-text));
        }

        .btn-secondary {
            background-color: #efeff4;
            color: #000;
        }

        .btn-add {
            background-color: #34c759; /* Green */
            color: white;
            margin-top: 15px;
            width: 100%;
        }

        /* –°–ø–∏—Å–æ–∫ –∑–∞–º–µ—á–∞–Ω–∏–π */
        #issues-list { margin-top: 20px; }
        
        .issue-card {
            background: var(--tg-theme-secondary-bg-color, #f9f9f9);
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 10px;
            position: relative;
            border-left: 4px solid var(--btn-color);
        }

        .issue-title { font-weight: bold; font-size: 14px; }
        .issue-desc { font-size: 13px; color: var(--tg-theme-hint-color, #666); margin-top: 4px; }
        
        .btn-delete {
            position: absolute;
            top: 10px;
            right: 10px;
            color: var(--danger-color);
            background: none;
            border: none;
            font-size: 18px;
            cursor: pointer;
            padding: 0;
        }

        .bottom-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            padding: 12px 16px 24px;
            background-color: var(--tg-theme-bg-color, var(--bg-color));
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            box-sizing: border-box;
            z-index: 100;
        }
    </style>
</head>
<body>

    <!-- –®–ê–ì 1: –û–±—â–∏–µ –¥–∞–Ω–Ω—ã–µ -->
    <div id="step1">
        <h2>üìÑ –®–∞–≥ 1: –û–±—â–∏–µ –¥–∞–Ω–Ω—ã–µ</h2>
        
        <label>–û–±—ä–µ–∫—Ç (–°–æ–æ—Ä—É–∂–µ–Ω–∏–µ)</label>
        <select id="building" onchange="updateAxes()">
            <option value="" disabled selected>–í—ã–±–µ—Ä–∏—Ç–µ –æ–±—ä–µ–∫—Ç</option>
            <option value="–ë–ª–æ–∫-—Å–µ–∫—Ü–∏—è 1">–ë–ª–æ–∫-—Å–µ–∫—Ü–∏—è 1</option>
            <option value="–ë–ª–æ–∫-—Å–µ–∫—Ü–∏—è 2">–ë–ª–æ–∫-—Å–µ–∫—Ü–∏—è 2</option>
            <option value="–ë–ª–æ–∫-—Å–µ–∫—Ü–∏—è 3">–ë–ª–æ–∫-—Å–µ–∫—Ü–∏—è 3</option>
            <option value="–ë–ª–æ–∫-—Å–µ–∫—Ü–∏—è 4">–ë–ª–æ–∫-—Å–µ–∫—Ü–∏—è 4</option>
            <option value="–ë–ª–æ–∫-—Å–µ–∫—Ü–∏—è 5">–ë–ª–æ–∫-—Å–µ–∫—Ü–∏—è 5</option>
            <option value="–ë–ª–æ–∫-—Å–µ–∫—Ü–∏—è 6">–ë–ª–æ–∫-—Å–µ–∫—Ü–∏—è 6</option>
            <option value="–ë–ª–æ–∫-—Å–µ–∫—Ü–∏—è 7">–ë–ª–æ–∫-—Å–µ–∫—Ü–∏—è 7</option>
            <option value="–ò–Ω—Ç–µ—Ä–Ω–∞—Ç">–ò–Ω—Ç–µ—Ä–Ω–∞—Ç</option>
            <option value="–¢—ë–ø–ª–∞—è —Å—Ç–æ—è–Ω–∫–∞">–¢—ë–ø–ª–∞—è —Å—Ç–æ—è–Ω–∫–∞</option>
        </select>

        <label>–ü–æ–¥—Ä—è–¥—á–∏–∫</label>
        <select id="contractor" onchange="checkContractor()">
            <option value="–ü–†–û–ù–¢–û">–û–û–û ¬´–ü–†–û–ù–¢–û¬ª</option>
            <option value="–°—Ç—Ä–æ–π–ú–æ–Ω–æ–ª–∏—Ç">–û–û–û ¬´–°—Ç—Ä–æ–π–ú–æ–Ω–æ–ª–∏—Ç¬ª</option>
            <option value="–°—Ç—Ä–æ–π –¢—Ä–µ–π–¥">–û–û–û ¬´–°—Ç—Ä–æ–π –¢—Ä–µ–π–¥¬ª</option>
            <option value="other">‚ûï –í–≤–µ—Å—Ç–∏ –≤—Ä—É—á–Ω—É—é...</option>
        </select>
        <input type="text" id="contractor_manual" class="hidden" placeholder="–†–µ–∫–≤–∏–∑–∏—Ç—ã –ø–æ–¥—Ä—è–¥—á–∏–∫–∞" style="margin-top:5px;">

        <div class="bottom-bar">
            <button class="btn btn-primary" onclick="goToStep2()" style="width:100%">–î–∞–ª–µ–µ: –î–æ–±–∞–≤–∏—Ç—å –∑–∞–º–µ—á–∞–Ω–∏—è ‚Üí</button>
        </div>
    </div>

    <!-- –®–ê–ì 2: –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∑–∞–º–µ—á–∞–Ω–∏–π -->
    <div id="step2" class="hidden">
        <h2>üõ† –ù–æ–≤–æ–µ –∑–∞–º–µ—á–∞–Ω–∏–µ</h2>

        <div style="background: var(--tg-theme-secondary-bg-color); padding: 10px; border-radius: 8px; margin-bottom: 15px;">
            <label style="margin-top:0">–≠—Ç–∞–∂</label>
            <select id="floor">
                <option value="1">1 —ç—Ç–∞–∂</option>
                <option value="2">2 —ç—Ç–∞–∂</option>
                <option value="3">3 —ç—Ç–∞–∂</option>
                <option value="4">4 —ç—Ç–∞–∂</option>
                <option value="–ö—Ä–æ–≤–ª—è">–ö—Ä–æ–≤–ª—è</option>
                <option value="–ü–æ–¥–≤–∞–ª">–ü–æ–¥–≤–∞–ª</option>
            </select>

            <label>–û—Å–∏ (–¶–∏—Ñ—Ä—ã / –ë—É–∫–≤—ã)</label>
            <div class="axis-group">
                <select id="axis_num_start"><option>-</option></select>
                <select id="axis_num_end"><option>-</option></select>
            </div>
            <div class="axis-group" style="margin-top:5px">
                <select id="axis_let_start"><option>-</option></select>
                <select id="axis_let_end"><option>-</option></select>
            </div>

            <label>–ö–æ–Ω—Å—Ç—Ä—É–∫—Ü–∏—è</label>
            <select id="structure">
                <option value="–°—Ç–µ–Ω–∞">–°—Ç–µ–Ω–∞</option>
                <option value="–ö–æ–ª–æ–Ω–Ω–∞">–ö–æ–ª–æ–Ω–Ω–∞</option>
                <option value="–ü–ª–∏—Ç–∞ –ø–µ—Ä–µ–∫—Ä—ã—Ç–∏—è">–ü–ª–∏—Ç–∞ –ø–µ—Ä–µ–∫—Ä—ã—Ç–∏—è</option>
                <option value="–ë–∞–ª–∫–∞">–ë–∞–ª–∫–∞</option>
                <option value="–û–∫–æ–Ω–Ω—ã–π –ø—Ä–æ–µ–º">–û–∫–æ–Ω–Ω—ã–π –ø—Ä–æ–µ–º</option>
                <option value="–ü–∞—Ä–∞–ø–µ—Ç">–ü–∞—Ä–∞–ø–µ—Ç</option>
                <option value="–õ–µ—Å—Ç–Ω–∏—á–Ω—ã–π –º–∞—Ä—à">–õ–µ—Å—Ç–Ω–∏—á–Ω—ã–π –º–∞—Ä—à</option>
            </select>

            <label>–ù–∞—Ä—É—à–µ–Ω–∏–µ</label>
            <textarea id="issue" rows="2" placeholder="–ö—Ä–∞—Ç–∫–æ –æ–ø–∏—à–∏—Ç–µ –¥–µ—Ñ–µ–∫—Ç"></textarea>

            <button class="btn btn-add" onclick="addIssue()">‚ûï –î–æ–±–∞–≤–∏—Ç—å –≤ —Å–ø–∏—Å–æ–∫</button>
        </div>

        <h3>–°–ø–∏—Å–æ–∫ –∑–∞–º–µ—á–∞–Ω–∏–π (<span id="count">0</span>)</h3>
        <div id="issues-list">
            <!-- –°—é–¥–∞ –¥–æ–±–∞–≤–ª—è—é—Ç—Å—è –∫–∞—Ä—Ç–æ—á–∫–∏ -->
            <div style="color: #999; font-style: italic; text-align: center; padding: 10px;">–°–ø–∏—Å–æ–∫ –ø—É—Å—Ç</div>
        </div>

        <div class="bottom-bar" style="display: flex; gap: 10px;">
            <button class="btn btn-secondary" onclick="backToStep1()" style="width: 30%">‚Üê –ù–∞–∑–∞–¥</button>
            <button class="btn btn-primary" onclick="sendAll()" style="width: 70%">–°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å</button>
        </div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.ready();
        tg.expand();

        let ISSUES = [];

        // –ë–∞–∑–∞ –æ—Å–µ–π (—Å–æ–∫—Ä–∞—â–µ–Ω–∞, –±—É–¥–µ—Ç –ø–æ–ª–Ω–∞—è)
        const AXES_DB = {
            "–ë–ª–æ–∫-—Å–µ–∫—Ü–∏—è 1": { num: ["2", "3", "4", "5"], let: ["–°", "–£", "–§", "–§/1", "–®", "–®/1", "–≠", "–≠/1", "–Æ", "–Ø", "–ë–ë"] },
            "–ë–ª–æ–∫-—Å–µ–∫—Ü–∏—è 2": { num: ["1", "2", "3", "4", "5"], let: ["–ï", "–ò", "–ò/1", "–ö", "–õ", "–ú", "–ú/2", "–ù", "–ü", "–†"] },
            "–ë–ª–æ–∫-—Å–µ–∫—Ü–∏—è 3": { num: ["6", "7", "8", "9", "9/1", "10", "10/1", "11", "11/1", "12", "13", "14", "14/1", "15"], let: ["–ö", "–õ", "–ú", "–ù", "–ü", "–ü/1", "–†", "–°", "–¢", "–£"] },
            "–ë–ª–æ–∫-—Å–µ–∫—Ü–∏—è 4": { num: ["6", "7", "8", "9", "9/1", "10", "10/1", "11", "11/1", "12", "13", "14", "14/1", "15"], let: ["–ï", "–ï/1", "–ñ", "–ò", "–ö/1"] },
            "–ë–ª–æ–∫-—Å–µ–∫—Ü–∏—è 5": { num: ["11", "11/1", "12", "13", "14", "14/1", "15", "16", "16/1", "17", "18", "19"], let: ["–£", "–£/1", "–§", "–®", "–≠", "–Æ", "–Ø", "–ê–ê", "–í–í", "–ì–ì", "–î–î", "–ê/1"] },
            "–ë–ª–æ–∫-—Å–µ–∫—Ü–∏—è 6": { num: ["16", "17", "18", "19", "20", "21", "22"], let: ["–ò", "–ö/1", "–ö", "–õ", "–ú", "–ù", "–ü", "–ü/1", "–†", "–°", "–¢"] },
            "–ë–ª–æ–∫-—Å–µ–∫—Ü–∏—è 7": { num: ["16", "16/1", "17", "18", "19", "20", "21", "22"], let: ["–ê", "–ë", "–í", "–í/1", "–ì", "–î", "–î/1", "–ï", "–ï/1", "–ñ"] },
            "–ò–Ω—Ç–µ—Ä–Ω–∞—Ç": { num: ["1", "2", "3", "4"], let: ["–ê", "–ë", "–í", "–ì", "–î", "–ï", "–ñ", "–ò", "–ö", "–õ", "–ú", "–ù", "–ü", "–†", "–°", "–¢", "–£"] },
            "–¢—ë–ø–ª–∞—è —Å—Ç–æ—è–Ω–∫–∞": { num: ["1", "2"], let: ["–ê", "–ë", "–í"] }
        };

        const CONTRACTORS = {
            "–ü–†–û–ù–¢–û": "–û–û–û ¬´–ü–†–û–ù–¢–û¬ª, 123112, –≥. –ú–æ—Å–∫–≤–∞, –Ω–∞–±. –ü—Ä–µ—Å–Ω–µ–Ω—Å–∫–∞—è, –¥. 12 –ø–æ–º. 14/64. –î–æ–≥–æ–≤–æ—Ä —Å—É–±–ø–æ–¥—Ä—è–¥–∞ ‚Ññ5930/01 –æ—Ç 13.01.2026 –≥.",
            "–°—Ç—Ä–æ–π–ú–æ–Ω–æ–ª–∏—Ç": "–û–û–û ¬´–°—Ç—Ä–æ–π–ú–æ–Ω–æ–ª–∏—Ç¬ª, 656066, –≥. –ë–∞—Ä–Ω–∞—É–ª, —É–ª. –û—Å—Ç—Ä–æ–≤—Å–∫–æ–≥–æ, –¥. 49, –ø–æ–º. –ù1. –î–æ–≥–æ–≤–æ—Ä –ø–æ–¥—Ä—è–¥–∞ ‚Ññ5732/07 –æ—Ç 07.07.2025 –≥.",
            "–°—Ç—Ä–æ–π –¢—Ä–µ–π–¥": "–û–û–û ¬´–°—Ç—Ä–æ–π –¢—Ä–µ–π–¥¬ª, 649100, –†–ê, –ú–∞–π–º–∏–Ω—Å–∫–∏–π —Ä-–Ω, —Å. –ú–∞–π–º–∞, —É–ª. –¢—Ä—É–¥–æ–≤–∞—è, –¥.34, –∫–≤. 2. –î–æ–≥–æ–≤–æ—Ä —Å—É–±–ø–æ–¥—Ä—è–¥–∞ ‚Ññ5720/07 –æ—Ç 01.07.2025 –≥."
        };

        function updateAxes() {
            const buildName = document.getElementById('building').value;
            const data = AXES_DB[buildName];
            fillSelect('axis_num_start', data?.num || []);
            fillSelect('axis_num_end', data?.num || []);
            fillSelect('axis_let_start', data?.let || []);
            fillSelect('axis_let_end', data?.let || []);
        }

        function fillSelect(id, values) {
            const sel = document.getElementById(id);
            sel.innerHTML = '<option value="">-</option>';
            values.forEach(v => {
                const opt = document.createElement('option');
                opt.value = v;
                opt.innerText = v;
                sel.appendChild(opt);
            });
        }

        function checkContractor() {
            const val = document.getElementById('contractor').value;
            document.getElementById('contractor_manual').style.display = (val === 'other') ? 'block' : 'none';
        }

        function goToStep2() {
            if (!document.getElementById('building').value) {
                tg.showPopup({message: '–í—ã–±–µ—Ä–∏—Ç–µ –æ–±—ä–µ–∫—Ç!'});
                return;
            }
            document.getElementById('step1').classList.add('hidden');
            document.getElementById('step2').classList.remove('hidden');
        }

        function backToStep1() {
            document.getElementById('step2').classList.add('hidden');
            document.getElementById('step1').classList.remove('hidden');
        }

        function getAxesString() {
            let axes = '';
            const n1 = document.getElementById('axis_num_start').value;
            const n2 = document.getElementById('axis_num_end').value;
            const l1 = document.getElementById('axis_let_start').value;
            const l2 = document.getElementById('axis_let_end').value;

            if (n1) axes += n1;
            if (n2 && n2 !== n1) axes += '-' + n2;
            if (l1) axes += (axes ? ' / ' : '') + l1;
            if (l2 && l2 !== l1) axes += '-' + l2;
            return axes || "–ù–µ —É–∫–∞–∑–∞–Ω—ã";
        }

        function addIssue() {
            const floor = document.getElementById('floor').value;
            const axes = getAxesString();
            const structure = document.getElementById('structure').value;
            const issueText = document.getElementById('issue').value.trim();

            if (!issueText) {
                tg.showPopup({message: '–û–ø–∏—à–∏—Ç–µ –Ω–∞—Ä—É—à–µ–Ω–∏–µ!'});
                return;
            }

            const item = {
                id: Date.now(),
                floor: floor,
                axes: axes,
                structure: structure,
                issue: issueText
            };

            ISSUES.push(item);
            renderList();
            
            // –û—á–∏—Å—Ç–∫–∞ –ø–æ–ª–µ–π
            document.getElementById('issue').value = '';
            // –û—Å–∏ –Ω–µ –æ—á–∏—â–∞–µ–º (—á–∞—Å—Ç–æ –∏–¥—É—Ç –ø–æ–¥—Ä—è–¥ –Ω–∞ –æ–¥–Ω–æ–º —ç—Ç–∞–∂–µ)
        }

        function removeIssue(id) {
            ISSUES = ISSUES.filter(i => i.id !== id);
            renderList();
        }

        function renderList() {
            const list = document.getElementById('issues-list');
            const count = document.getElementById('count');
            
            count.innerText = ISSUES.length;
            list.innerHTML = '';

            if (ISSUES.length === 0) {
                list.innerHTML = '<div style="color: #999; font-style: italic; text-align: center; padding: 10px;">–°–ø–∏—Å–æ–∫ –ø—É—Å—Ç</div>';
                return;
            }

            ISSUES.forEach((item, index) => {
                const card = document.createElement('div');
                card.className = 'issue-card';
                card.innerHTML = `
                    <div class="issue-title">#${index + 1}. ${item.structure} (${item.floor} —ç—Ç, ${item.axes})</div>
                    <div class="issue-desc">${item.issue}</div>
                    <button class="btn-delete" onclick="removeIssue(${item.id})">√ó</button>
                `;
                list.appendChild(card);
            });
        }

        function sendAll() {
            if (ISSUES.length === 0) {
                tg.showPopup({message: '–°–ø–∏—Å–æ–∫ –ø—É—Å—Ç! –î–æ–±–∞–≤—å—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω–æ –∑–∞–º–µ—á–∞–Ω–∏–µ.'});
                return;
            }

            const cVal = document.getElementById('contractor').value;
            const contractorData = cVal === 'other' ? document.getElementById('contractor_manual').value : CONTRACTORS[cVal];

            const data = {
                action: "create_prescription_multi",
                building: document.getElementById('building').value,
                contractor_info: contractorData || "–ü–æ–¥—Ä—è–¥—á–∏–∫ –Ω–µ –≤—ã–±—Ä–∞–Ω",
                items: ISSUES
            };

            try {
                tg.sendData(JSON.stringify(data));
            } catch (e) {
                alert("–û—à–∏–±–∫–∞: " + e.message);
            }
        }
    </script>
</body>
</html>
