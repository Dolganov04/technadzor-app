<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–¢–ù: –ü—Ä–µ–¥–ø–∏—Å–∞–Ω–∏–µ</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body {
            font-family: sans-serif;
            padding: 16px;
            margin: 0;
            padding-bottom: 150px; /* –ë–æ–ª—å—à–æ–π –æ—Ç—Å—Ç—É–ø —Å–Ω–∏–∑—É */
        }
        
        select, input, textarea {
            width: 100%;
            padding: 12px;
            margin-bottom: 10px;
            border: 1px solid #ccc;
            border-radius: 8px;
            box-sizing: border-box;
            font-size: 16px;
        }

        .btn {
            padding: 15px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: bold;
            text-align: center;
            display: block;
            width: 100%;
            margin-top: 10px;
            cursor: pointer;
        }

        .btn-primary { background-color: #2481cc; color: #fff; }
        .btn-add { background-color: #34c759; color: #fff; }
        
        /* –ö–ù–û–ü–ö–ê –§–û–¢–û - –Ø–†–ö–ê–Ø */
        .btn-photo {
            background-color: #ff9500;
            color: #fff;
            margin-bottom: 15px;
        }

        .hidden { display: none; }
        .axis-group { display: flex; gap: 5px; }
        
        .issue-card {
            background: #f0f0f0;
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 8px;
            position: relative;
        }
        
        .bottom-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background: white;
            padding: 15px;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            display: flex;
            gap: 10px;
            z-index: 999;
        }
    </style>
</head>
<body>

    <!-- –®–ê–ì 1 -->
    <div id="step1">
        <h3>–®–∞–≥ 1: –û–±—ä–µ–∫—Ç</h3>
        <select id="building" onchange="updateAxes()">
            <option value="" disabled selected>–í—ã–±–µ—Ä–∏—Ç–µ –æ–±—ä–µ–∫—Ç...</option>
            <option value="–ë–ª–æ–∫-—Å–µ–∫—Ü–∏—è 1">–ë–ª–æ–∫-—Å–µ–∫—Ü–∏—è 1</option>
            <option value="–ë–ª–æ–∫-—Å–µ–∫—Ü–∏—è 2">–ë–ª–æ–∫-—Å–µ–∫—Ü–∏—è 2</option>
            <option value="–ë–ª–æ–∫-—Å–µ–∫—Ü–∏—è 3">–ë–ª–æ–∫-—Å–µ–∫—Ü–∏—è 3</option>
            <option value="–ë–ª–æ–∫-—Å–µ–∫—Ü–∏—è 4">–ë–ª–æ–∫-—Å–µ–∫—Ü–∏—è 4</option>
            <option value="–ë–ª–æ–∫-—Å–µ–∫—Ü–∏—è 5">–ë–ª–æ–∫-—Å–µ–∫—Ü–∏—è 5</option>
            <option value="–ë–ª–æ–∫-—Å–µ–∫—Ü–∏—è 6">–ë–ª–æ–∫-—Å–µ–∫—Ü–∏—è 6</option>
            <option value="–ë–ª–æ–∫-—Å–µ–∫—Ü–∏—è 7">–ë–ª–æ–∫-—Å–µ–∫—Ü–∏—è 7</option>
            <option value="–ò–Ω—Ç–µ—Ä–Ω–∞—Ç">–ò–Ω—Ç–µ—Ä–Ω–∞—Ç</option>
            <option value="–¢—ë–ø–ª–∞—è —Å—Ç–æ—è–Ω–∫–∞">–¢—ë–ø–ª–∞—è —Å—Ç–æ—è–Ω–∫–∞</option>
        </select>

        <h3>–ü–æ–¥—Ä—è–¥—á–∏–∫</h3>
        <select id="contractor" onchange="checkContractor()">
            <option value="–ü–†–û–ù–¢–û">–û–û–û ¬´–ü–†–û–ù–¢–û¬ª</option>
            <option value="–°—Ç—Ä–æ–π–ú–æ–Ω–æ–ª–∏—Ç">–û–û–û ¬´–°—Ç—Ä–æ–π–ú–æ–Ω–æ–ª–∏—Ç¬ª</option>
            <option value="–°—Ç—Ä–æ–π –¢—Ä–µ–π–¥">–û–û–û ¬´–°—Ç—Ä–æ–π –¢—Ä–µ–π–¥¬ª</option>
            <option value="other">–î—Ä—É–≥–æ–π...</option>
        </select>
        <input type="text" id="contractor_manual" class="hidden" placeholder="–†–µ–∫–≤–∏–∑–∏—Ç—ã">

        <button class="btn btn-primary" onclick="goToStep2()">–î–∞–ª–µ–µ</button>
    </div>

    <!-- –®–ê–ì 2 -->
    <div id="step2" class="hidden">
        <h3>–ù–æ–≤–æ–µ –∑–∞–º–µ—á–∞–Ω–∏–µ</h3>
        
        <select id="floor">
            <option value="1">1 —ç—Ç–∞–∂</option>
            <option value="2">2 —ç—Ç–∞–∂</option>
            <option value="3">3 —ç—Ç–∞–∂</option>
            <option value="4">4 —ç—Ç–∞–∂</option>
        </select>

        <div class="axis-group">
            <select id="axis_num_start"><option>-</option></select>
            <select id="axis_num_end"><option>-</option></select>
        </div>
        <div class="axis-group" style="margin-top:5px">
            <select id="axis_let_start"><option>-</option></select>
            <select id="axis_let_end"><option>-</option></select>
        </div>

        <select id="structure" style="margin-top:10px">
            <option value="–°—Ç–µ–Ω–∞">–°—Ç–µ–Ω–∞</option>
            <option value="–ö–æ–ª–æ–Ω–Ω–∞">–ö–æ–ª–æ–Ω–Ω–∞</option>
            <option value="–ü–ª–∏—Ç–∞">–ü–ª–∏—Ç–∞</option>
        </select>

        <textarea id="issue" rows="2" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ..."></textarea>

        <!-- –ö–ù–û–ü–ö–ê –§–û–¢–û -->
        <label for="cam" class="btn btn-photo">üì∏ –°–ù–Ø–¢–¨ –§–û–¢–û</label>
        <input type="file" id="cam" accept="image/*" capture="environment" style="display:none">

        <button class="btn btn-add" onclick="addIssue()">‚ûï –î–æ–±–∞–≤–∏—Ç—å</button>

        <hr>
        <div id="issues-list"></div>

        <div class="bottom-bar">
            <button class="btn" style="background:#ddd; width:30%" onclick="backToStep1()">–ù–∞–∑–∞–¥</button>
            <button class="btn btn-primary" style="width:70%" onclick="sendAll()">–°–§–û–†–ú–ò–†–û–í–ê–¢–¨</button>
        </div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.ready();
        tg.expand();

        let ISSUES = [];
        
        // (–û—Å–∏ –∏ –ø–æ–¥—Ä—è–¥—á–∏–∫–∏ - —Å–æ–∫—Ä–∞—â–µ–Ω–Ω–æ –¥–ª—è –ø—Ä–∏–º–µ—Ä–∞, –Ω–∞ GitHub –±—É–¥–µ—Ç –ø–æ–ª–Ω–∞—è –≤–µ—Ä—Å–∏—è)
        const AXES_DB = { "–ë–ª–æ–∫-—Å–µ–∫—Ü–∏—è 1": { num: ["1","2"], let: ["A","B"] } }; 
        const CONTRACTORS = { "–ü–†–û–ù–¢–û": "–û–û–û –ü–†–û–ù–¢–û..." };

        function goToStep2() {
            document.getElementById('step1').classList.add('hidden');
            document.getElementById('step2').classList.remove('hidden');
        }
        function backToStep1() {
            document.getElementById('step2').classList.add('hidden');
            document.getElementById('step1').classList.remove('hidden');
        }

        function addIssue() {
            const txt = document.getElementById('issue').value;
            if(!txt) { alert("–ù–∞–ø–∏—à–∏—Ç–µ –∑–∞–º–µ—á–∞–Ω–∏–µ!"); return; }
            
            ISSUES.push({
                floor: document.getElementById('floor').value,
                axes: "1-2/–ê-–ë", // –ó–∞–≥–ª—É—à–∫–∞ –¥–ª—è —Ç–µ—Å—Ç–∞, —Ä–µ–∞–ª—å–Ω—ã–π –∫–æ–¥ –≤–æ–∑—å–º–µ—Ç –∏–∑ –ø–æ–ª–µ–π
                structure: document.getElementById('structure').value,
                issue: txt
            });
            
            render();
            document.getElementById('issue').value = "";
        }

        function render() {
            const div = document.getElementById('issues-list');
            div.innerHTML = ISSUES.map((i, idx) => 
                `<div class="issue-card">#${idx+1} ${i.structure}: ${i.issue}</div>`
            ).join('');
        }

        function sendAll() {
            // DEBUG
            // alert("–ö–Ω–æ–ø–∫–∞ –Ω–∞–∂–∞—Ç–∞! –ó–∞–º–µ—á–∞–Ω–∏–π: " + ISSUES.length);

            if (ISSUES.length === 0) {
                alert("–°–ø–∏—Å–æ–∫ –ø—É—Å—Ç!");
                return;
            }

            const data = {
                action: "create_prescription_multi",
                building: document.getElementById('building').value || "–¢–µ—Å—Ç",
                contractor_info: "–¢–µ—Å—Ç",
                items: ISSUES
            };

            try {
                tg.sendData(JSON.stringify(data));
                // alert("sendData –≤—ã–∑–≤–∞–Ω!");
            } catch (e) {
                alert("–û—à–∏–±–∫–∞: " + e.message);
            }
        }
        
        // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–æ–ª–Ω—É—é –ë–î –æ—Å–µ–π –ø—Ä–∏ –∑–∞–ª–∏–≤–∫–µ
    </script>
</body>
</html>
